name: Provision K3s Cluster

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  TF_VAR_hetzner_token: ${{ secrets.HETZNER_TOKEN }}
  TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

jobs:
  terraform:
    name: Terraform ${{ github.event.inputs.action }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform/environments/demo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action == 'plan'
        run: terraform plan

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        run: terraform apply -auto-approve

      - name: Save Terraform Outputs
        if: github.event.inputs.action == 'apply'
        id: tf-outputs
        run: |
          echo "master_ip=$(terraform output -raw master_ip)" >> $GITHUB_OUTPUT
          echo "worker_ips=$(terraform output -json worker_ips)" >> $GITHUB_OUTPUT

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: terraform destroy -auto-approve

      - name: Upload Terraform State
        if: github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: terraform/environments/demo/terraform.tfstate

  ansible:
    name: Configure K3s with Ansible
    runs-on: ubuntu-latest
    needs: terraform
    if: github.event.inputs.action == 'apply'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Terraform State
        uses: actions/download-artifact@v4
        with:
          name: terraform-state
          path: terraform/environments/demo

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $(cd terraform/environments/demo && terraform output -raw master_ip) >> ~/.ssh/known_hosts

      - name: Generate Ansible Inventory
        working-directory: terraform/environments/demo
        run: |
          MASTER_IP=$(terraform output -raw master_ip)
          WORKER_IPS=$(terraform output -json worker_ips | jq -r '.[]')

          cat > ../../ansible/inventory/hosts <<EOF
          [master]
          k3s-master ansible_host=${MASTER_IP} ansible_user=root

          [workers]
          EOF

          i=1
          for ip in $WORKER_IPS; do
            echo "k3s-worker-${i} ansible_host=${ip} ansible_user=root" >> ../../ansible/inventory/hosts
            i=$((i+1))
          done

          cat >> ../../ansible/inventory/hosts <<EOF

          [k3s_cluster:children]
          master
          workers
          EOF

      - name: Run Ansible Playbook
        working-directory: ansible
        run: ansible-playbook -i inventory/hosts site.yml

      - name: Upload Kubeconfig
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: kubeconfig
